# __pycache__ Pollution

## What this is

This signal detects when Python `__pycache__` directories or `.pyc` (compiled bytecode) files are tracked in Git version control. These files are automatically generated by Python when modules are imported and should never be committed to repositories.

## Why this matters

**Repository Hygiene**:
- **Bloated repository**: `.pyc` files add unnecessary size to your Git repository
- **Merge conflicts**: Different Python versions generate different bytecode, causing conflicts
- **Build artifacts**: Compiled files should be generated during build, not committed
- **Cross-platform issues**: Bytecode from one platform may not work on another

**Security Concerns**:
- **Stale code execution**: Old `.pyc` files may execute outdated code even after `.py` files are updated
- **Code injection**: Attackers can modify `.pyc` files to inject malicious code
- **Obfuscation**: Malicious bytecode is harder to review than source code

**Development Issues**:
- **Confusion**: Developers may not realize they're running old bytecode
- **Debugging difficulty**: Debuggers may show wrong line numbers with stale `.pyc` files
- **CI/CD failures**: Different Python versions in CI may fail due to incompatible bytecode

## How to remediate

### Remove __pycache__ from Git

**Check if tracked**:
```bash
# Find all __pycache__ directories in Git
git ls-files | grep __pycache__

# Find all .pyc files in Git
git ls-files | grep '\.pyc$'
```

**Remove from Git** (keep local files):
```bash
# Remove __pycache__ directories
git rm -r --cached **/__pycache__

# Remove .pyc files
git rm --cached **/*.pyc

# Or remove all at once
find . -name "__pycache__" -type d -exec git rm -r --cached {} + 2>/dev/null
find . -name "*.pyc" -type f -exec git rm --cached {} + 2>/dev/null
```

**Add to .gitignore**:
```bash
# Add Python-specific ignores
cat >> .gitignore <<'EOF'
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg
EOF
```

**Commit the changes**:
```bash
git add .gitignore
git commit -m "Remove __pycache__ from version control and update .gitignore"
```

### Clean up local __pycache__ directories

**Remove all __pycache__ directories**:
```bash
# Find and remove all __pycache__ directories
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null

# Or use Python's built-in tool
python3 -Bc "import pathlib; [p.rmdir() for p in pathlib.Path('.').rglob('__pycache__')]"
```

**Remove all .pyc files**:
```bash
# Find and remove all .pyc files
find . -type f -name "*.pyc" -delete

# Also remove .pyo files (optimized bytecode)
find . -type f -name "*.pyo" -delete
```

### Prevent future __pycache__ creation

**Use PYTHONDONTWRITEBYTECODE**:
```bash
# Add to ~/.bashrc or ~/.zshrc
export PYTHONDONTWRITEBYTECODE=1

# Or run Python with -B flag
python3 -B script.py

# Or set in Python script
import sys
sys.dont_write_bytecode = True
```

**Configure in IDE**:

**VS Code** (settings.json):
```json
{
  "python.terminal.executeInFileDir": true,
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true
  }
}
```

**PyCharm**:
- Settings → Build, Execution, Deployment → Python Compiler
- Uncheck "Compile Python files"

### Purge from Git history (if needed)

**If __pycache__ was committed many times**:
```bash
# WARNING: This rewrites history - coordinate with team!

# Using git-filter-repo (recommended)
git filter-repo --path __pycache__ --invert-paths
git filter-repo --path '*.pyc' --invert-paths

# Or using BFG Repo-Cleaner
bfg --delete-folders __pycache__
bfg --delete-files '*.pyc'
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Force push (WARNING: destructive)
git push origin --force --all
```

### Add pre-commit hook

**Create .git/hooks/pre-commit**:
```bash
#!/bin/bash
# Prevent committing __pycache__ or .pyc files

if git diff --cached --name-only | grep -qE '(__pycache__|\.pyc$)'; then
  echo "Error: Attempting to commit __pycache__ or .pyc files!"
  echo "These files should not be in version control."
  echo ""
  echo "Run: git rm -r --cached **/__pycache__ **/*.pyc"
  echo "And add them to .gitignore"
  exit 1
fi
```

**Make it executable**:
```bash
chmod +x .git/hooks/pre-commit
```

### Platform-specific cleanup

**macOS/Linux**:
```bash
# Remove all __pycache__ recursively
find . -type d -name __pycache__ -prune -exec rm -rf {} +

# Remove all .pyc files
find . -type f \( -name "*.pyc" -o -name "*.pyo" \) -delete

# Add to .gitignore
echo "__pycache__/" >> .gitignore
echo "*.py[cod]" >> .gitignore
```

**Windows (PowerShell)**:
```powershell
# Remove all __pycache__ directories
Get-ChildItem -Path . -Filter __pycache__ -Recurse -Directory | Remove-Item -Recurse -Force

# Remove all .pyc files
Get-ChildItem -Path . -Filter *.pyc -Recurse -File | Remove-Item -Force

# Add to .gitignore
Add-Content .gitignore "__pycache__/"
Add-Content .gitignore "*.py[cod]"
```

### Best practices

1. **Always use .gitignore** for Python projects:
   ```bash
   # Use a standard Python .gitignore
   curl https://raw.githubusercontent.com/github/gitignore/main/Python.gitignore -o .gitignore
   ```

2. **Clean before committing**:
   ```bash
   # Add to your workflow
   find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
   git add .
   git commit
   ```

3. **Use virtual environments**:
   ```bash
   # Create virtual environment
   python3 -m venv venv

   # Add to .gitignore
   echo "venv/" >> .gitignore
   ```

4. **Configure Python to not write bytecode** in development:
   ```bash
   # Add to ~/.bashrc or ~/.zshrc
   export PYTHONDONTWRITEBYTECODE=1
   ```

5. **Use .dockerignore** for Docker builds:
   ```dockerfile
   # .dockerignore
   __pycache__/
   *.py[cod]
   *$py.class
   ```

6. **Clean in CI/CD**:
   ```yaml
   # .github/workflows/ci.yml
   - name: Clean Python cache
     run: find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
   ```

7. **Review pull requests** for bytecode files:
   ```bash
   # Check PR for .pyc files
   git diff main...feature-branch --name-only | grep -E '(__pycache__|\.pyc$)'
   ```

### Why __pycache__ exists

Python creates `__pycache__` directories to store compiled bytecode (`.pyc` files) for faster module loading. This is normal and beneficial for performance, but these files should be:
- **Generated locally** on each machine
- **Not committed** to version control
- **Ignored** in .gitignore
- **Cleaned** before distribution


## Disabling This Signal

To disable this signal, set the environment variable:
```
export DASHLIGHTS_DISABLE_PYCACHE_POLLUTION=1
```

To disable permanently, add the above line to your shell configuration file (`~/.zshrc`, `~/.bashrc`, etc.).
