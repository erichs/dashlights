name: Release

# Trigger on push to main (after PR merge)
# The release tag is on HEAD^2 (the PR branch tip, second parent of merge commit)
on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check_tag.outputs.is_release }}
      tag_name: ${{ steps.check_tag.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for release tag on HEAD^2
        id: check_tag
        run: |
          # Get the tag on HEAD^2 (the PR branch tip, second parent of merge commit)
          TAG=$(git describe --tags --exact-match HEAD^2 2>/dev/null || echo "")
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Found release tag: $TAG"
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG" >> $GITHUB_OUTPUT
          else
            echo "No release tag found on HEAD^2"
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
          fi

  goreleaser:
    needs: check-release
    if: needs.check-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Checkout the tagged commit, not the merge commit
          ref: ${{ needs.check-release.outputs.tag_name }}

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Generate repository URL
        run: cd src && go generate

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

